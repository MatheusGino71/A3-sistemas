# üîî Sistema de Notifica√ß√µes - Sentinela PIX

## Vis√£o Geral

O Sistema de Notifica√ß√µes do Sentinela PIX oferece uma experi√™ncia completa de gerenciamento de notifica√ß√µes em tempo real, integrado com Firebase e backend Node.js.

## üìã Funcionalidades

### 1. **Dropdown de Notifica√ß√µes**
- Badge din√¢mico com contador de notifica√ß√µes n√£o lidas
- Lista de notifica√ß√µes com scroll personalizado
- Notifica√ß√µes categorizadas por tipo (alerta, sucesso, informa√ß√£o)
- Timestamps relativos ("5min atr√°s", "2h atr√°s", etc.)
- Marca√ß√£o visual de notifica√ß√µes n√£o lidas
- Bot√£o "Marcar todas como lidas"

### 2. **Menu de Usu√°rio**
- Avatar com iniciais geradas automaticamente
- Nome e email do usu√°rio (carregados do Firebase/localStorage)
- Op√ß√µes de menu:
  - üë§ Meu Perfil
  - ‚öôÔ∏è Configura√ß√µes
  - üîî Prefer√™ncias de Notifica√ß√µes
  - üö™ Sair

### 3. **Sistema Autom√°tico**
- Verifica√ß√£o de novas notifica√ß√µes a cada 30 segundos
- Toast de notifica√ß√£o quando novas mensagens chegam
- Cache local para performance (localStorage)
- Sincroniza√ß√£o com backend quando dispon√≠vel

## üé® Design

### Cores por Tipo de Notifica√ß√£o
- **Vermelho** (`red`): Alertas e fraudes detectadas
- **Verde** (`green`): Confirma√ß√µes e sucessos
- **Azul** (`blue`): Informa√ß√µes gerais
- **Amarelo** (`yellow`): Avisos

### √çcones Material Symbols
- `warning` - Alertas
- `check_circle` - Sucessos
- `info` - Informa√ß√µes
- `error` - Erros

## üîß Arquitetura

### Frontend (`user-system.js`)

```javascript
// Classes principais
NotificationSystem      // Gerencia notifica√ß√µes
UserProfileSystem       // Gerencia perfil do usu√°rio

// M√©todos principais
loadNotifications()     // Carrega notifica√ß√µes do backend
renderNotifications()   // Renderiza lista de notifica√ß√µes
markAsRead(id)          // Marca notifica√ß√£o como lida
markAllAsRead()         // Marca todas como lidas
checkNewNotifications() // Verifica novas notifica√ß√µes (polling)
```

### Backend (`server.js`)

```javascript
// Endpoints
GET  /api/v1/notifications?userId={uid}       // Buscar notifica√ß√µes
PUT  /api/v1/notifications/:id/read           // Marcar como lida
PUT  /api/v1/notifications/read-all           // Marcar todas como lidas
GET  /api/v1/notifications/check?userId={uid} // Verificar novas
```

### Banco de Dados (SQLite)

```sql
CREATE TABLE notifications (
    id TEXT PRIMARY KEY,
    user_id TEXT,
    fraud_report_id TEXT,
    type TEXT NOT NULL,
    title TEXT NOT NULL,
    message TEXT NOT NULL,
    icon TEXT DEFAULT 'info',
    color TEXT DEFAULT 'blue',
    read_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

## üì¶ Instala√ß√£o

### 1. Backend j√° est√° configurado
As altera√ß√µes no `server.js` j√° incluem:
- ‚úÖ Tabela de notifica√ß√µes criada automaticamente
- ‚úÖ Endpoints de API prontos
- ‚úÖ Migra√ß√µes de colunas

### 2. Frontend j√° est√° configurado
Os arquivos foram criados/atualizados:
- ‚úÖ `user-system.js` - Sistema completo
- ‚úÖ `dashboard.html` - Dropdowns integrados
- ‚úÖ Estilos e anima√ß√µes adicionados

## üöÄ Como Usar

### Para Usu√°rios

1. **Ver Notifica√ß√µes**
   - Clique no √≠cone de sino üîî no header
   - Badge vermelho mostra n√∫mero de n√£o lidas

2. **Ler Notifica√ß√£o**
   - Clique em qualquer notifica√ß√£o
   - Ser√° marcada automaticamente como lida

3. **Marcar Todas como Lidas**
   - Clique em "Marcar todas como lidas" no topo do dropdown

4. **Menu de Usu√°rio**
   - Clique no avatar no canto superior direito
   - Acesse perfil, configura√ß√µes ou saia do sistema

### Para Desenvolvedores

#### Adicionar Nova Notifica√ß√£o (Backend)

```javascript
// Inserir notifica√ß√£o no banco
db.run(`INSERT INTO notifications (id, user_id, type, title, message, icon, color) 
        VALUES (?, ?, ?, ?, ?, ?, ?)`,
       [uuid(), userId, 'alert', 'Fraude Detectada', 'Nova tentativa...', 'warning', 'red']);
```

#### Adicionar Notifica√ß√£o (Frontend - Para testes)

```javascript
// No console do navegador
notificationSystem.addNotification({
    type: 'success',
    title: 'Teste de Notifica√ß√£o',
    message: 'Esta √© uma notifica√ß√£o de teste',
    icon: 'check_circle',
    color: 'green'
});
```

## üîÑ Fluxo de Dados

```
1. Backend detecta evento (fraude, relat√≥rio, etc.)
   ‚Üì
2. Backend insere notifica√ß√£o no banco de dados
   ‚Üì
3. Frontend faz polling a cada 30s (checkNewNotifications)
   ‚Üì
4. Se houver novas, chama loadNotifications()
   ‚Üì
5. renderNotifications() atualiza UI
   ‚Üì
6. Badge √© atualizado com contador
   ‚Üì
7. Toast aparece avisando o usu√°rio
```

## üéØ Pr√≥ximas Funcionalidades

### Em Desenvolvimento
- ‚è≥ P√°gina de perfil do usu√°rio completa
- ‚è≥ P√°gina de configura√ß√µes
- ‚è≥ Prefer√™ncias de notifica√ß√µes (email, push, etc.)

### Planejadas
- üîÆ WebSocket para notifica√ß√µes em tempo real (substituir polling)
- üîÆ Firebase Cloud Messaging (notifica√ß√µes push)
- üîÆ Filtros de notifica√ß√µes por tipo
- üîÆ Hist√≥rico completo de notifica√ß√µes
- üîÆ Notifica√ß√µes por email
- üîÆ Sons personaliz√°veis para notifica√ß√µes

## üêõ Troubleshooting

### Notifica√ß√µes n√£o aparecem

**Problema**: Dropdown vazio mesmo ap√≥s login

**Solu√ß√£o**:
1. Verifique se h√° `user.uid` no localStorage
2. Abra o console: `localStorage.getItem('user')`
3. Verifique se backend est√° rodando: `http://localhost:3001/health`
4. Teste o endpoint: `http://localhost:3001/api/v1/notifications?userId=SEU_UID`

### Badge n√£o atualiza

**Problema**: Contador de notifica√ß√µes n√£o lidas n√£o muda

**Solu√ß√£o**:
1. Limpe o cache: `localStorage.removeItem('notifications')`
2. Recarregue a p√°gina
3. Verifique no console se h√° erros de JavaScript

### Toast n√£o aparece

**Problema**: Notifica√ß√£o nova mas sem toast visual

**Solu√ß√£o**:
1. Verifique se a anima√ß√£o CSS est√° carregada
2. Procure por `@keyframes slide-in` no `<style>`
3. Teste manualmente: `notificationSystem.showNewNotificationToast()`

## üìù Exemplos de Uso

### Criar Notifica√ß√£o de Fraude Detectada

```javascript
// Backend - Ap√≥s detectar fraude
const notificationId = require('crypto').randomUUID();
db.run(`INSERT INTO notifications 
        (id, user_id, fraud_report_id, type, title, message, icon, color) 
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
       [notificationId, userId, reportId, 'alert', 
        'Nova tentativa de fraude detectada',
        `Chave PIX ${pixKey} foi bloqueada automaticamente`,
        'warning', 'red']);
```

### Criar Notifica√ß√£o de Relat√≥rio Processado

```javascript
// Backend - Ap√≥s processar relat√≥rio
db.run(`INSERT INTO notifications 
        (id, user_id, fraud_report_id, type, title, message, icon, color) 
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
       [notificationId, userId, reportId, 'success',
        'Relat√≥rio processado com sucesso',
        `Seu relat√≥rio #${reportId.slice(0, 8)} foi analisado`,
        'check_circle', 'green']);
```

## üîê Seguran√ßa

- ‚úÖ Notifica√ß√µes s√£o isoladas por `user_id`
- ‚úÖ Backend valida `userId` em todos os endpoints
- ‚úÖ Firestore rules limitam acesso a notifica√ß√µes pr√≥prias
- ‚úÖ Token JWT valida autentica√ß√£o em rotas protegidas

## üìä Performance

- **Cache local**: Notifica√ß√µes s√£o salvas no localStorage
- **Polling inteligente**: Verifica apenas se h√° novas (n√£o recarrega todas)
- **Lazy rendering**: Renderiza apenas notifica√ß√µes vis√≠veis
- **Debounce**: Evita m√∫ltiplas chamadas simult√¢neas

## üé® Customiza√ß√£o

### Alterar intervalo de verifica√ß√£o

```javascript
// Em user-system.js, linha 17
setInterval(() => this.checkNewNotifications(), 30000); // 30 segundos

// Alterar para 60 segundos:
setInterval(() => this.checkNewNotifications(), 60000);
```

### Adicionar novo tipo de notifica√ß√£o

```javascript
// 1. Adicionar cor no createNotificationHTML()
const colorClasses = {
    red: 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400',
    green: 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400',
    blue: 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400',
    yellow: 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400',
    purple: 'bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400' // NOVO
};

// 2. Usar no addNotification()
notificationSystem.addNotification({
    type: 'custom',
    title: 'Notifica√ß√£o Especial',
    message: 'Mensagem personalizada',
    icon: 'star',
    color: 'purple'
});
```

## üìö Refer√™ncias

- [Tailwind CSS](https://tailwindcss.com/docs)
- [Material Symbols](https://fonts.google.com/icons)
- [Firebase Auth](https://firebase.google.com/docs/auth)
- [Firebase Firestore](https://firebase.google.com/docs/firestore)

## ü§ù Contribuindo

Para adicionar novas funcionalidades ao sistema de notifica√ß√µes:

1. Atualize a tabela no `server.js` se necess√°rio
2. Crie o endpoint no backend
3. Adicione o m√©todo no `NotificationSystem` class
4. Teste com notifica√ß√µes de exemplo
5. Documente as mudan√ßas neste README

---

**Vers√£o**: 1.0.0  
**√öltima Atualiza√ß√£o**: Outubro 2025  
**Autor**: Sentinela PIX Team
