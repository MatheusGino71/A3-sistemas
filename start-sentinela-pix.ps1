# Script PowerShell para inicializar o Sentinela PIX
# Uso: .\start-sentinela-pix.ps1

Write-Host "üöÄ Iniciando Sentinela PIX - Sistema Anti-Fraude PIX" -ForegroundColor Green
Write-Host "===============================================" -ForegroundColor Green

# Verificar se Node.js est√° instalado
try {
    $nodeVersion = node --version
    Write-Host "‚úÖ Node.js encontrado: $nodeVersion" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Node.js n√£o encontrado. Instale Node.js primeiro." -ForegroundColor Red
    exit 1
}

# Verificar se Python est√° instalado
try {
    $pythonVersion = python --version
    Write-Host "‚úÖ Python encontrado: $pythonVersion" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Python n√£o encontrado. Instale Python primeiro." -ForegroundColor Red
    exit 1
}

Write-Host "‚úÖ Depend√™ncias verificadas" -ForegroundColor Green

# Navegar para o diret√≥rio do backend
Set-Location backend

# Verificar se node_modules existe
if (-not (Test-Path "node_modules")) {
    Write-Host "üì¶ Instalando depend√™ncias do backend..." -ForegroundColor Yellow
    npm install
}

Write-Host "üîß Iniciando backend..." -ForegroundColor Blue

# Iniciar backend em background
$backendProcess = Start-Process -FilePath "node" -ArgumentList "server.js" -PassThru -NoNewWindow

# Aguardar backend inicializar
Start-Sleep -Seconds 3

# Verificar se backend est√° rodando
try {
    $response = Invoke-WebRequest -Uri "http://localhost:3001/health" -UseBasicParsing -TimeoutSec 5
    if ($response.StatusCode -eq 200) {
        Write-Host "‚úÖ Backend iniciado com sucesso na porta 3001" -ForegroundColor Green
    }
} catch {
    Write-Host "‚ùå Erro ao iniciar backend" -ForegroundColor Red
    Stop-Process -Id $backendProcess.Id -Force
    exit 1
}

# Navegar para o frontend
Set-Location ../frontend

Write-Host "üñ•Ô∏è Iniciando frontend..." -ForegroundColor Blue

# Iniciar frontend em background
$frontendProcess = Start-Process -FilePath "python" -ArgumentList "-m", "http.server", "8080" -PassThru -NoNewWindow

# Aguardar frontend inicializar
Start-Sleep -Seconds 2

Write-Host ""
Write-Host "üéâ Sentinela PIX est√° rodando!" -ForegroundColor Green
Write-Host "================================" -ForegroundColor Green
Write-Host "üñ•Ô∏è Dashboard Frontend: http://localhost:8080" -ForegroundColor Cyan
Write-Host "üîß API Backend: http://localhost:3001/api/v1" -ForegroundColor Cyan
Write-Host "‚ù§Ô∏è Health Check: http://localhost:3001/health" -ForegroundColor Cyan
Write-Host ""
Write-Host "üí° Para parar os servi√ßos:" -ForegroundColor Yellow
Write-Host "   - Backend PID: $($backendProcess.Id)" -ForegroundColor Yellow
Write-Host "   - Frontend PID: $($frontendProcess.Id)" -ForegroundColor Yellow
Write-Host "   - Use Ctrl+C neste terminal" -ForegroundColor Yellow
Write-Host ""
Write-Host "üìä Acesse o dashboard em: http://localhost:8080" -ForegroundColor Magenta

# Aguardar Ctrl+C
try {
    Write-Host "Pressione Ctrl+C para parar os servi√ßos..." -ForegroundColor Gray
    while ($true) {
        Start-Sleep -Seconds 1
        
        # Verificar se os processos ainda est√£o rodando
        if ($backendProcess.HasExited) {
            Write-Host "‚ö†Ô∏è Backend parou inesperadamente!" -ForegroundColor Red
            break
        }
        if ($frontendProcess.HasExited) {
            Write-Host "‚ö†Ô∏è Frontend parou inesperadamente!" -ForegroundColor Red
            break
        }
    }
} finally {
    Write-Host "üõë Parando servi√ßos..." -ForegroundColor Yellow
    
    if (-not $backendProcess.HasExited) {
        Stop-Process -Id $backendProcess.Id -Force -ErrorAction SilentlyContinue
        Write-Host "‚úÖ Backend parado" -ForegroundColor Green
    }
    
    if (-not $frontendProcess.HasExited) {
        Stop-Process -Id $frontendProcess.Id -Force -ErrorAction SilentlyContinue
        Write-Host "‚úÖ Frontend parado" -ForegroundColor Green
    }
    
    Write-Host "üëã Sentinela PIX encerrado!" -ForegroundColor Green
}